const path = require("path");
const HtmlWebpackPlugin = require("html-webpack-plugin");
const CopyWebpackPlugin = require("copy-webpack-plugin");
const { InjectManifest } = require("workbox-webpack-plugin");
const crypto = require("crypto");

module.exports = {
  // –†–µ–∂–∏–º —Ä–∞–±–æ—Ç—ã. 'development' –¥–ª—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏, 'production' –¥–ª—è –ø—Ä–æ–¥–∞–∫—à–µ–Ω–∞.
  // –í –¥–µ–≤-—Ä–µ–∂–∏–º–µ —Å–±–æ—Ä–∫–∞ –±—ã—Å—Ç—Ä–µ–µ –∏ –µ—Å—Ç—å —Å–æ—É—Ä—Å-–º–∞–ø—ã. –í –ø—Ä–æ–¥–µ - –∫–æ–¥ –º–∏–Ω–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω.
  mode: "development",

  // –¢–æ—á–∫–∞ –≤—Ö–æ–¥–∞. –û—Ç—Å—é–¥–∞ –≤–µ–±–ø–∞–∫ –Ω–∞—á–∏–Ω–∞–µ—Ç —Å—Ç—Ä–æ–∏—Ç—å –¥–µ—Ä–µ–≤–æ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π.
  // –£ –Ω–∞—Å —ç—Ç–æ –±—É–¥–µ—Ç, –¥–æ–ø—É—Å—Ç–∏–º, index.js –≤ –ø–∞–ø–∫–µ src.
  entry: "./src/index.js",

  // –ö—É–¥–∞ —Å–∫–ª–∞–¥—ã–≤–∞—Ç—å —Å–æ–±—Ä–∞–Ω–Ω—ã–π –±–∞–Ω–¥–ª.
  output: {
    // –ò–º—è —Ñ–∞–π–ª–∞ –±–∞–Ω–¥–ª–∞. [name] –ø–æ–¥—Å—Ç–∞–≤–∏—Ç –∏–º—è –∏–∑ entry (main), [contenthash] –¥–ª—è –∫–µ—à–∏—Ä–æ–≤–∞–Ω–∏—è.
    filename: "main.[contenthash].js",
    // –î–∏—Ä–µ–∫—Ç–æ—Ä–∏—è –¥–ª—è —Å–±–æ—Ä–∫–∏. path.resolve –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç –∫—Ä–æ—Å—Å-–ø–ª–∞—Ç—Ñ–æ—Ä–º–µ–Ω–Ω–æ—Å—Ç—å.
    path: path.resolve(__dirname, "dist"),
    // –ß–∏—Å—Ç–∏—Ç—å –ø–∞–ø–∫—É dist –ø–µ—Ä–µ–¥ –∫–∞–∂–¥–æ–π –Ω–æ–≤–æ–π —Å–±–æ—Ä–∫–æ–π. –ü–æ–ª–µ–∑–Ω–∞—è —Ö—É–π–Ω—è.
    clean: true,
  },

  // –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –¥–ª—è dev-—Å–µ—Ä–≤–µ—Ä–∞. –ß—Ç–æ–±—ã –Ω–µ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞—Ç—å —Å–±–æ—Ä–∫—É —Ä—É–∫–∞–º–∏ –∫–∞–∂–¥—ã–π —Ä–∞–∑.
  devServer: {
    static: {
      directory: path.join(__dirname, "dist"),
    },
    compress: true,
    port: 9000,
    open: true, // –±—É–¥–µ—Ç –æ—Ç–∫—Ä—ã–≤–∞—Ç—å –±—Ä–∞—É–∑–µ—Ä —Å–∞–º, –∑–∞–µ–±—ë—à—å—Å—è –∑–∞–∫—Ä—ã–≤–∞—Ç—å
  },

  // –ú–æ–¥—É–ª–∏ –∏ –ø—Ä–∞–≤–∏–ª–∞ –∏—Ö –æ–±—Ä–∞–±–æ—Ç–∫–∏. –°–∞–º–æ–µ –º—è—Å–æ —Ç—É—Ç.
  module: {
    rules: [
      {
        // –í—Å–µ —Ñ–∞–π–ª—ã, –∑–∞–∫–∞–Ω—á–∏–≤–∞—é—â–∏–µ—Å—è –Ω–∞ .js –∏–ª–∏ .jsx
        test: /\.jsx?$/,
        // –ò—Å–∫–ª—é—á–∞–µ–º node_modules, –Ω–∞–º –Ω–µ –Ω—É–∂–Ω–æ –∏—Ö –ø–µ—Ä–µ—Å–æ–±–∏—Ä–∞—Ç—å. –ó–∞–ø–æ–º–Ω–∏ —ç—Ç–æ, –±–ª—è–¥—å.
        exclude: /node_modules/,
        // –ò—Å–ø–æ–ª—å–∑—É–µ–º babel-loader –¥–ª—è —Ç—Ä–∞–Ω—Å–ø–∞–π–ª–∏–Ω–≥–∞ ES6+/JSX –≤ —Å—Ç–∞—Ä—ã–π –¥–æ–±—Ä—ã–π ES5.
        use: {
          loader: "babel-loader",
          options: {
            // –ü—Ä–µ—Å–µ—Ç—ã –¥–ª—è Babel. @babel/preset-env –¥–ª—è —Å–æ–≤—Ä–µ–º–µ–Ω–Ω–æ–≥–æ JS, @babel/preset-react –¥–ª—è JSX.
            presets: ["@babel/preset-env", "@babel/preset-react"],
            // –Ø–≤–Ω–æ —É–∫–∞–∑—ã–≤–∞–µ–º, —á—Ç–æ —Ñ–∞–π–ª—ã —è–≤–ª—è—é—Ç—Å—è ES-–º–æ–¥—É–ª—è–º–∏. –≠—Ç–æ —Ä–µ—à–∞–µ—Ç –ø—Ä–æ–±–ª–µ–º—É —Å 'import',
            // –∫–æ–≥–¥–∞ –≤ package.json —Å—Ç–æ–∏—Ç "type": "commonjs".
            sourceType: "module",
          },
        },
      },
      {
        // –¢–µ–ø–µ—Ä—å –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –∏ CSS —Ñ–∞–π–ª—ã.
        test: /\.css$/,
        // –ò—Å–ø–æ–ª—å–∑—É–µ–º –¥–≤–∞ –ª–æ–∞–¥–µ—Ä–∞. –ü–æ—Ä—è–¥–æ–∫ –≤–∞–∂–µ–Ω: webpack –ø—Ä–∏–º–µ–Ω—è–µ—Ç –∏—Ö —Å–ø—Ä–∞–≤–∞ –Ω–∞–ª–µ–≤–æ (—Å–Ω–∞—á–∞–ª–∞ css-loader, –ø–æ—Ç–æ–º style-loader).
        use: ["style-loader", "css-loader"],
      },
    ],
  },

  // –ü–ª–∞–≥–∏–Ω—ã. –†–∞—Å—à–∏—Ä—è—é—Ç –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ –≤–µ–±–ø–∞–∫–∞.
  plugins: [
    // –≠—Ç–æ—Ç –ø–ª–∞–≥–∏–Ω —Å–∞–º —Å–æ–∑–¥–∞—Å—Ç index.html –≤ –ø–∞–ø–∫–µ dist –∏ –ø–æ–¥–∫–ª—é—á–∏—Ç –∫ –Ω–µ–º—É –Ω–∞—à –±–∞–Ω–¥–ª.
    // –ò–∑–±–∞–≤–ª—è–µ—Ç –æ—Ç –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ –¥–µ–ª–∞—Ç—å —ç—Ç–æ —Ä—É–∫–∞–º–∏.
    new HtmlWebpackPlugin({
      // –¢–µ–ø–µ—Ä—å Webpack –±—É–¥–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Ç–≤–æ–π src/index.html –∫–∞–∫ —à–∞–±–ª–æ–Ω –¥–ª—è —Å–±–æ—Ä–∫–∏.
      template: "./src/index.html",
    }),
    // –ö–æ–ø–∏—Ä—É–µ–º —Å—Ç–∞—Ç–∏—á–µ—Å–∫–∏–µ —Ñ–∞–π–ª—ã –∏–∑ `public` –≤ `dist`
    new CopyWebpackPlugin({
      patterns: [
        // –ö–æ–ø–∏—Ä—É–µ–º –≤—Å—ë –∏–∑ src/public –≤ –∫–æ—Ä–µ–Ω—å dist
        // –ò—Å–∫–ª—é—á–∞–µ–º sw.js, —Ç–∞–∫ –∫–∞–∫ –æ–Ω –±—É–¥–µ—Ç —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω Workbox'–æ–º
        { from: "src/public", to: ".", globOptions: { ignore: ["**/sw.js"] } },
      ],
    }),
    // –ò—Å–ø–æ–ª—å–∑—É–µ–º InjectManifest –¥–ª—è –±–æ–ª—å—à–µ–≥–æ –∫–æ–Ω—Ç—Ä–æ–ª—è –Ω–∞–¥ SW.
    // –û–Ω –≤–æ–∑—å–º—ë—Ç –Ω–∞—à —à–∞–±–ª–æ–Ω sw-template.js, –≤—Å—Ç–∞–≤–∏—Ç –≤ –Ω–µ–≥–æ —Å–ø–∏—Å–æ–∫ —Ñ–∞–π–ª–æ–≤ –¥–ª—è –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏—è
    // –∏ —Å–æ–∑–¥–∞—Å—Ç –≥–æ—Ç–æ–≤—ã–π sw.js –≤ –ø–∞–ø–∫–µ dist.
    new InjectManifest({
      swSrc: "./src/sw-template.js", // –ù–∞—à —à–∞–±–ª–æ–Ω service worker'–∞
      swDest: "sw.js", // –í—ã—Ö–æ–¥–Ω–æ–π —Ñ–∞–π–ª service worker'–∞
      exclude: [
        /\.map$/, // –ò—Å–∫–ª—é—á–∞–µ–º source maps
        /manifest\.json$/, // –ò—Å–∫–ª—é—á–∞–µ–º –º–∞–Ω–∏—Ñ–µ—Å—Ç (–±—É–¥–µ–º –∫—ç—à–∏—Ä–æ–≤–∞—Ç—å –æ—Ç–¥–µ–ª—å–Ω–æ –≤ sw-template.js)
        /\.DS_Store$/, // –ò—Å–∫–ª—é—á–∞–µ–º —Å–∏—Å—Ç–µ–º–Ω—ã–µ —Ñ–∞–π–ª—ã macOS
        /^manifest.*\.js$/, // –ò—Å–∫–ª—é—á–∞–µ–º webpack –º–∞–Ω–∏—Ñ–µ—Å—Ç—ã
      ],
      maximumFileSizeToCacheInBytes: 5 * 1024 * 1024, // 5MB –º–∞–∫—Å–∏–º—É–º –¥–ª—è –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏—è
      // –í–ù–ò–ú–ê–ù–ò–ï: –≠—Ç–æ—Ç transform –∑–∞—Å—Ç–∞–≤–ª—è–µ—Ç –≤—Å–µ —Ñ–∞–π–ª—ã –ø–µ—Ä–µ–∫–∞—á–∏–≤–∞—Ç—å—Å—è –ø—Ä–∏ –∫–∞–∂–¥–æ–π –Ω–æ–≤–æ–π —Å–±–æ—Ä–∫–µ,
      // –¥–∞–∂–µ –µ—Å–ª–∏ –æ–Ω–∏ –Ω–µ –∏–∑–º–µ–Ω–∏–ª–∏—Å—å. –≠—Ç–æ –º–æ–∂–µ—Ç –±—ã—Ç—å –ø–æ–ª–µ–∑–Ω–æ –¥–ª—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏, –Ω–æ –¥–ª—è –ø—Ä–æ–¥–∞–∫—à–µ–Ω–∞
      // —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è —É–¥–∞–ª–∏—Ç—å `manifestTransforms`, —á—Ç–æ–±—ã Workbox –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–ª —Ö—ç—à–∏ –Ω–∞ –æ—Å–Ω–æ–≤–µ
      // —Å–æ–¥–µ—Ä–∂–∏–º–æ–≥–æ —Ñ–∞–π–ª–æ–≤ –¥–ª—è —É–º–Ω–æ–≥–æ –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏—è.
      manifestTransforms: [
        (manifestEntries) => {
          const manifest = manifestEntries.map((entry) => {
            const revision = crypto
              .createHash("md5")
              .update(Buffer.from(entry.url + Date.now()))
              .digest("hex");

            return { ...entry, revision: revision.substring(0, 8) };
          });

          console.log(`üì¶ Workbox precache: ${manifest.length} —Ñ–∞–π–ª–æ–≤`);
          // –í–æ–∑–≤—Ä–∞—â–∞–µ–º –º–∞–Ω–∏—Ñ–µ—Å—Ç –∏ –ø—É—Å—Ç–æ–π –º–∞—Å—Å–∏–≤ –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–π
          return { manifest, warnings: [] };
        },
      ],
    }),
  ],
};
